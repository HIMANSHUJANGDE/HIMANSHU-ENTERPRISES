<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>A4 Photo Print</title>

<style>
body { margin: 0; font-family: Arial; }

@page { size: A4 portrait; margin: 8mm; }

/* Control Panel */
#controls {
    padding: 15px;
    background: #f2f2f2;
    border-bottom: 1px solid #ccc;
}

#previewList {
    margin-top: 15px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.previewItem {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px;
    border: 1px solid #ccc;
    background: #fff;
}

.previewItem img {
    width: 70px;
    border: 1px solid #aaa;
}

/* Print Layout */
#photoArea {
    display: flex;
    flex-wrap: wrap;
    gap: 4mm;
    padding: 8mm;
}

.photoBox {
    width: 35mm;
    height: 25mm;
    border: 0.5mm solid #000;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}

.photoBox img { width: 100%; }

/* CROP MODAL */
#cropModal {
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.8);
    display:none;
    justify-content:center;
    align-items:center;
}

#cropBox {
    background:white;
    padding:20px;
    border-radius:8px;
}

#cropCanvas {
    border:1px solid #333;
    cursor:grab;
}

@media print {
    #controls, #previewList, #cropModal { display:none !important; }
    #photoArea { padding:0; gap:3mm; }
}
</style>

</head>
<body>

<div id="controls">
    <h3>A4 Multi-Image Photo Generator</h3>

    <input type="file" id="fileInput" accept="image/*" onchange="loadImage()">
    <p>Upload → Crop → Zoom → Rotate → PCS → Generate → Print</p>

    <div id="previewList"></div>
    <button onclick="generate()">Generate Photos</button>
    <button onclick="window.print()">Print</button>
</div>

<div id="photoArea"></div>

<!-- Crop Modal -->
<div id="cropModal">
    <div id="cropBox">
        <h3>Crop Image</h3>
        <canvas id="cropCanvas" width="400" height="300"></canvas><br><br>

        Zoom:
        <input type="range" id="zoomSlider" min="0.5" max="3" step="0.05" value="1">
        <br><br>

        <button onclick="applyCrop()">Apply Crop</button>
        <button onclick="closeCrop()">Cancel</button>
    </div>
</div>

<script>
let images = []; // {src, croppedSrc, pcs, rotate}
let cropIndex;
let cropImg = new Image();
let zoom = 1;
let offsetX = 0, offsetY = 0;
let drag = false;

// CANVAS
const canvas = document.getElementById("cropCanvas");
const ctx = canvas.getContext("2d");

// ---------------------------------------------------------
// Load image into preview
// ---------------------------------------------------------
function loadImage() {
    const file = fileInput.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = e => {
        const id = images.length;
        images.push({
            src: e.target.result,
            croppedSrc: e.target.result,
            pcs: 6,
            rotate: 0
        });

        const item = document.createElement("div");
        item.className = "previewItem";
        item.id = "item_" + id;

        item.innerHTML = `
            <img src="${e.target.result}" id="prev_${id}">
            <div>
                PCS: <input type="number" value="6" min="1"
                       onchange="images[${id}].pcs=this.value"><br>

                Rotate:
                <select onchange="rotate(${id}, this.value)">
                    <option value="0">0°</option>
                    <option value="90">90°</option>
                    <option value="180">180°</option>
                    <option value="270">270°</option>
                </select><br>

                <button onclick="openCrop(${id})">Crop</button>
            </div>
        `;

        previewList.appendChild(item);
    };

    reader.readAsDataURL(file);
    fileInput.value = "";
}

function rotate(id, deg) {
    images[id].rotate = deg;
    document.getElementById("prev_" + id).style.transform = `rotate(${deg}deg)`;
}

// ---------------------------------------------------------
// CROPPING TOOL (ZOOM + MOVE)
// ---------------------------------------------------------
function openCrop(id) {
    cropIndex = id;
    cropImg.src = images[id].croppedSrc;

    cropImg.onload = () => {
        zoom = 1;
        offsetX = 0;
        offsetY = 0;

        drawCrop();
    };

    document.getElementById("zoomSlider").value = 1;
    cropModal.style.display = "flex";
}

// Draw image inside crop canvas
function drawCrop() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(
        cropImg,
        offsetX, offsetY,
        cropImg.width * zoom,
        cropImg.height * zoom
    );
}

// Mouse Move (drag image)
canvas.onmousedown = () => drag = true;
canvas.onmouseup = () => drag = false;

canvas.onmousemove = e => {
    if (drag) {
        offsetX += e.movementX;
        offsetY += e.movementY;
        drawCrop();
    }
};

// Mouse Wheel Zoom
canvas.onwheel = e => {
    e.preventDefault();
    zoom += e.deltaY * -0.001;
    zoom = Math.min(Math.max(0.5, zoom), 3);
    zoomSlider.value = zoom;
    drawCrop();
};

// Slider Zoom
zoomSlider.oninput = function() {
    zoom = parseFloat(this.value);
    drawCrop();
};

// Apply Crop
function applyCrop() {
    let temp = document.createElement("canvas");
    temp.width = 400;
    temp.height = 300;
    let tctx = temp.getContext("2d");

    tctx.drawImage(cropImg, offsetX, offsetY, cropImg.width * zoom, cropImg.height * zoom);

    let data = temp.toDataURL("image/jpeg");
    images[cropIndex].croppedSrc = data;

    document.getElementById("prev_" + cropIndex).src = data;

    closeCrop();
}

function closeCrop() {
    cropModal.style.display = "none";
}

// ---------------------------------------------------------
// GENERATE PRINT PAGE
// ---------------------------------------------------------
function generate() {
    photoArea.innerHTML = "";

    images.forEach(img => {
        for (let i = 0; i < img.pcs; i++) {
            const box = document.createElement("div");
            box.className = "photoBox";

            const im = document.createElement("img");
            im.src = img.croppedSrc;
            im.style.transform = `rotate(${img.rotate}deg)`;

            box.appendChild(im);
            photoArea.appendChild(box);
        }
    });
}
</script>

</body>
</html>
